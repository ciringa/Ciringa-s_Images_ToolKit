<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body> 
    <div id="app">
        <div class="card">
            <h2>Remover background</h2>
            <form action="http://127.0.0.1:4545/image/remove" method="post" enctype="multipart/form-data" id="form3">
                <input type="file" name="avatar" id="sub_file3">
                <input type="submit" class="subInputs" value="Processar Imagem">
            </form>
        </div>

        <div class="card">
            <h2>Alterar escala</h2>
            <form action="http://127.0.0.1:4545/image/rescale" method="post" enctype="multipart/form-data" id="form1">
                <input type="file" name="avatar" id="sub_file2">
                <input type="number" name="scale">
                <input type="submit" class="subInputs" value="Processar Imagem">
            </form>
        </div>

        <div class="card">
            <button id="test">Testar</button>
        </div>
    </div>
</body>
<script>
    //downloadImage("C:/programacao/Ciringas_Images_ToolKit/.temp/images/7b53e78f-517a-466f-9442-382eae6299e3.png")
    async function downloadImage(psUrl) {
            try{
                var fileUrl = psUrl
                const url = 'http://127.0.0.1:4545/image/download'
                const data = {
                    fileUrl
                }
                const request = await fetch(url,{
                    method:"PATCH",
                    headers: {
                    'Content-Type': 'application/json', // Especifica o tipo de conteúdo como JSON
                    },
                    body:JSON.stringify(data)
                })
                const blob = await request.blob();
                // Cria um URL para o blob
                const res_url = window.URL.createObjectURL(blob);
                // Cria um link temporário para baixar a imagem
                const link = document.createElement("a");
                link.href = res_url;
                link.download = "image.png"; // Nome do arquivo a ser baixado
                document.body.appendChild(link);

                // Aciona o download
                link.click();

                // Remove o link temporário
                document.body.removeChild(link);

                // Libera o URL do Blob para liberar memória
                window.URL.revokeObjectURL(res_url);

            }catch(err){
                console.log(err)
            }
    }
    
    document.getElementById('form1').addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o comportamento padrão do formulário

            const form = document.getElementById('form1');
            const formData = new FormData(form);

            try {
                const response = await fetch('http://127.0.0.1:4545/image/rescale', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('Imagem processada:', result);
                    const ptUrl = result.ResultFromPython
                    console.log("image is at: "+ptUrl)
                    await downloadImage(ptUrl)
                } else {
                    console.error('Erro ao processar a imagem:', response.statusText);
                }
            } catch (error) {
                console.error('Erro de conexão:', error);
            }
        });

    document.getElementById('form3').addEventListener('submit', async function(event) {
        event.preventDefault(); // Impede o envio padrão do formulário

        const form = document.getElementById('form3');
        const formData = new FormData(form); // Cria um FormData com os dados do formulário

        try {
            const response = await fetch('http://127.0.0.1:4545/image/remove', {
                method: 'POST',
                body: formData, // Envia os dados do formulário
            });
            
            if (response.ok) {
                const result = await response.json(); // Processa a resposta como JSON
                console.log('Imagem processada:', result);
                const ptUrl = result.ResultFromPython.replace(" ","");
                console.log("image is at: "+ptUrl)
                await downloadImage(ptUrl);
            } else {
                console.error('Erro ao processar a imagem:', response.statusText);
            }
        } catch (error) {
            console.error('Erro na requisição:', error);
        }
    });

    const btnTest = document.getElementById("test").addEventListener("click",downloadImage)
</script>
<style>

    #app{
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: row;
        gap: 5%;
        flex-wrap: wrap;
        justify-content: center;

    }

    .card{
        border-radius: 20px;
        border: 1px dashed gray ;
        background-color: rgb(238, 238, 238);
        display: flex;
        flex-direction: column;
        gap: 5%;
        justify-content: center;
        align-items: center;
        padding: 60px;
        width: 300px;
        gap: 10px;column-gap: 10px;
        margin: 10px;

    }
    .card input{
        width: 90%;
        outline: none;border: none;
        height: 30px;text-align: center;
    }
    .card button{
        margin-top: 10px;cursor: pointer;
        font-size: 20px;font-weight: bold;
        width: 90%;height: 40px;
        background-color: rgb(0, 110, 255);
        border: none;outline: none;color: white;
    }
    .card select{
        color: gray;text-align: center;
        width: 90%;height: 25px;
        outline: none;border: none;
    }
    h2{ 
        text-align: center;
        color: rgb(80, 80, 80);
        font-family: 'Times New Roman', Times, serif;
    }
    .subInputs{
        margin-top: 10px;cursor: pointer;
        font-size: 20px;font-weight: bold;
        width: 90%;height: 40px;
        background-color: rgb(0, 110, 255);
        border: none;outline: none;color: white;
    }
</style>
</html>